#include "Window.h"
#include "Os.h"
#include "MiscUtil.h"
#include "MathUtil.h"
#include "Array.h"
#include "Rendering.h"
#include "Simd.h"
#include "Set.h"
#include "Ring.h"
#include <iostream>
#include <sstream>

static void FlushToDebugOutput(std::stringstream& stream) {
    if (stream.rdbuf()->in_avail()) {
        auto text = stream.str();
        gg::Os::PrintDebug(text.c_str());
        stream = std::stringstream();
    }
}

struct Timing {
    int64_t rawTimer = gg::Os::GetRawTimer();
    float lastFrameMilliseconds = 16.67f;
    float avgFrameMilliseconds = 16.67f;

    void advanceFrame(gg::Os const& os) {
        int64_t rawTimerOld = std::exchange(rawTimer, os.GetRawTimer());
        lastFrameMilliseconds = os.asFloatMilliseconds(rawTimer - rawTimerOld);
        avgFrameMilliseconds = gg::Lerp(avgFrameMilliseconds, lastFrameMilliseconds, 0.05f);
    }
};

int main(int argc, char* argv[]) {
    gg::Os os;
    GG_SCOPE_EXIT(std::cout << "Bye!\n"; os.Sleep(200));

    std::stringstream debugPrint;

    GG_SCOPE_EXIT(std::cout << "done\n");
    std::cout << "Creating window...";
    gg::Window window("Giggity");
    std::cout << "done\n";
    GG_SCOPE_EXIT(std::cout << "Tearing down window...");

    unsigned width = 0;
    unsigned height = 0;

    std::cout << "Starting renderer...";
    gg::Rendering::Hub renderingHub(nullptr);
    std::cout << "done\n";
    {
        uint8_t rgbaData[] = {
            0xff,0x00,0xff,0xff, 0xff,0x00,0xff,0xff, 0xff,0x00,0xff,0xff, 0xff,0x00,0xff,0xff, 0xff,0x00,0xff,0xff, 0xff,0x00,0xff,0xff, 0xff,0x00,0xff,0xff, 0xff,0x00,0xff,0xff, 
            0xff,0x00,0xff,0xff, 0xff,0x00,0xff,0xff, 0xff,0x00,0xff,0xff, 0xff,0x00,0xff,0xff, 0xff,0x00,0xff,0xff, 0xff,0x00,0xff,0xff, 0xff,0x00,0xff,0xff, 0xff,0x00,0xff,0xff, 
            0xff,0x00,0xff,0xff, 0xff,0x00,0xff,0xff, 0xff,0x00,0xff,0xff, 0xff,0x00,0xff,0xff, 0xff,0x00,0xff,0xff, 0xff,0x00,0xff,0xff, 0xff,0x00,0xff,0xff, 0xff,0x00,0xff,0xff, 
            0xff,0x00,0xff,0xff, 0xff,0x00,0xff,0xff, 0xff,0x00,0xff,0xff, 0xff,0x00,0xff,0xff, 0xff,0x00,0xff,0xff, 0xff,0x00,0xff,0xff, 0xff,0x00,0xff,0xff, 0xff,0x00,0xff,0xff, 
            0xff,0x00,0xff,0xff, 0xff,0x00,0xff,0xff, 0xff,0x00,0xff,0xff, 0xff,0x00,0xff,0xff, 0xff,0x00,0xff,0xff, 0xff,0x00,0xff,0xff, 0xff,0x00,0xff,0xff, 0xff,0x00,0xff,0xff, 
            0xff,0x00,0xff,0xff, 0xff,0x00,0xff,0xff, 0xff,0x00,0xff,0xff, 0xff,0x00,0xff,0xff, 0xff,0x00,0xff,0xff, 0xff,0x00,0xff,0xff, 0xff,0x00,0xff,0xff, 0xff,0x00,0xff,0xff, 
            0xff,0x00,0xff,0xff, 0xff,0x00,0xff,0xff, 0xff,0x00,0xff,0xff, 0xff,0x00,0xff,0xff, 0xff,0x00,0xff,0xff, 0xff,0x00,0xff,0xff, 0xff,0x00,0xff,0xff, 0xff,0x00,0xff,0xff, 
            0xff,0x00,0xff,0xff, 0xff,0x00,0xff,0xff, 0xff,0x00,0xff,0xff, 0xff,0x00,0xff,0xff, 0xff,0x00,0xff,0xff, 0xff,0x00,0xff,0xff, 0xff,0x00,0xff,0xff, 0xff,0x00,0xff,0xff, 
        };
        std::cout << "Exercising renderer...";
        gg::Array<uint8_t> pixels;
        pixels.addLastCopiedSpan(rgbaData);
        gg::RenderFormat const rgba8888 = {gg::RenderFormat::Layout::cRGBA, gg::RenderFormat::BitDepth::c8, gg::RenderFormat::Type::cUnorm};
        gg::Rendering::Image image(&renderingHub, pixels, rgba8888, 8, 8);
        std::cout << "done\n";

        std::cout << "Creating pipeline...";
        gg::Rendering::Pipeline pipeline(&renderingHub, window.hwnd());
        std::cout << "done\n";

        gg::Window::ShowConsole(false);

        unsigned frames = 0;
        Timing timing;
        while (!window.isClosing()) {
            gg::Rendering rendering = renderingHub.startRendering(pipeline);
            rendering.addImage(0.f, 0.f, image);
            renderingHub.submitRendering(std::move(rendering));

            timing.advanceFrame(os);

            frames++;

            if (os.IsDebuggerPresent()) {
                if (frames % 512 == 128) {
                    debugPrint << "Frame period:\t" << timing.avgFrameMilliseconds << " milliseconds\n";
                }
                if (os.GetClientSize(window.hwnd(), width, height)) {
                    debugPrint << "Output dimensions:\t" << width << "x" << height << " pixels\n";
                }
                FlushToDebugOutput(debugPrint);
            }
        }

        //gg::Window::ShowConsole(true);
    }

    std::cout << "Waiting for window to close...";
    window.waitForClose();
    std::cout << "done\n";
    return 0;
}
